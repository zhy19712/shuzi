<link rel="stylesheet" type="text/css" href="/static/admin/webupload/webuploader.css">
<link rel="stylesheet" type="text/css" href="/static/admin/webupload/style.css">
<link rel="stylesheet" href="/static/admin/css/zTreeStyle/zTreeStyle.css">
<link rel="stylesheet" href="/static/admin/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="/static/admin/css/jedate.css">
<link rel="stylesheet" href="/static/admin/css/iconfont.css">
<link rel="stylesheet" href="/static/admin/css/bootstrap.min.css">
{include file="public/header" /}
<body>
    <style>
        .mycontent{
            width: 20%;
            height: 98%;
            display: inline-block;
            background-color: #fff;
            overflow-x: scroll;
            border-right: 1px solid #ccc;
        }
        .mycontent h2{
            font-size: 16px;
            border-bottom: 1px solid #ccc;
            margin: 0;
            padding: 10px 0;
            text-align: center;
        }
        .ztree li span.button.add {
            margin-left:2px;
            margin-right: -1px;
            background-position:-144px 0;
            vertical-align:top;
            *vertical-align:middle;
        }
        .wrapper {
            display: inline-block;
            width: 78%;
            vertical-align: top;
            padding: 0;
        }
        #path{
            line-height: 30px;
            font-weight: 700;
            border-bottom: 1px solid #ccc;
        }
        .dataTables_wrapper .dataTables_filter{
            float: left;
        }
        .dt-buttons{
            float: right;
            margin-top: 5px;
        }
        .btn-primary{
            background-color: none !important;
            border-color: none !important;
        }
        .btn-upload{
            padding: 0;
            margin: 0;
            height: 34px;
        }
        .btn-upload .webuploader-pick{
            padding: 7px 15px;
            border-radius:0;
        }
        #tableItem .btn{
            margin-right: 2px;
        }
    </style>

    <div id="mycontent" class="mycontent">
        <h2>法律标准分类</h2>
        <ul id="tree_container" class="ztree"></ul>
    </div>
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <div class="row">
                    <div id="path">当前路径:</div>
                    <div id="table_info">
                        <div id="level">
                            <table id="tableItem" class="table table-striped table-bordered" cellspacing="0"  width="100%">
                                <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>标准号</th>
                                    <th>名称</th>
                                    <th>施行日期</th>
                                    <th>适用性评价</th>
                                    <th>识别人</th>
                                    <th>上传日期</th>
                                    <th>备注</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addRules_modal" data-keyboard="false" data-backdrop="static" class="modal animated fadeInRight" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width: 60%;margin: 0 auto;margin-top: 40px;">
        <div class="row">
            <div class="col-sm-12" style="background-color:#fff;">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5></h5>
                    </div>
                    <input type="text" name="uid" id="id1" style="display: none;" value="">
                    <div class="ibox-content">
                        <!--新增用户信息开始-->
                        <form class="form-horizontal" name="memberAdd" id="memberAdd" method="post">
                            <input type="text" name="id" id="sid" style="display: none;">
                            <input type="text" name="group_id" id="pgroup_id" style="display: none;">
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label col-sm-offset-2 col-xs-offset-0">标准号：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="standardNumr" type="text" class="form-control" name="standardNumr" >
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-12 col-xs-12">
                                    <label class="col-xs-3 col-sm-3 control-label">名称：</label>
                                    <div class="myblock col-xs- input-group">
                                        <input id="addName" type="text" class="form-control" name="addName" >
                                        <span class="input-group-btn">
                                            <div class="btn btn-upload" id="picker">上传</div>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label col-sm-offset-2 col-xs-offset-0">施行日期：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="dataImple" type="text" class="form-control" name="dataImple" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">替代标准：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="alternativeStandard" type="text" class="form-control" name="alternativeStandard" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-6 control-label col-xs-offset-0">适用性评价：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <select name="sex" id="psex" class="form-control" >
                                            <option value="0">适用</option>
                                            <option value="-1">过期</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">识别人：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="pdivision" type="text" class="form-control" name="division" >
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="col-lg-12 col-xs-12">
                                <label class="col-xs-2 col-sm-2 control-label">备注：</label>
                                <div class="myblock col-xs-10 col-sm-10 input-group">
                                    <textarea name="rulesDesc" id="rulesDesc" style="width: 100%;min-height: 100px;"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-xs-12 col-lg-12"  style="text-align: center;margin-top: 10px">
                                    <button class="btn btn-primary" type="button" id="save"><i class="fa fa-save"></i> 保存</button>&nbsp;&nbsp;&nbsp;
                                    <a class="btn btn-danger" data-dismiss="modal"><i class="fa fa-close"></i> 返回</a>
                                </div>
                            </div>
                        </form>
                        <!--新增用户信息结束-->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div>
    </div>


    {include file="public/footer" /}
    <script type="text/javascript" src="/static/admin/webupload/webuploader.min.js"></script>

    <script src="__JS__/jquery.ztree.all.js"></script>
    <script src="__JS__/jquery.dataTables.min.js"></script>
    <script src="__JS__/plugins/dataTables/dataTables.buttons.min.js"></script>
    <script src="__JS__/jquery.jedate.js"></script>
    <script src="__JS__/pdf.js"></script>
    <script src="__JS__/mypdf.js"></script>

    <script>
        //左侧菜单
        var node = [
            {name:"法律法规"},
            {name: "标准规范", children: [
                {name: "国家标准"},
                {name: "安监行业标准"},
                {name: "水利水电行业标准"},
                {name: "建筑行业标准"}
             ]}
        ]
        var setting = {
            view:{
                addHoverDom: addHoverDom,
                removeHoverDom: removeHoverDom,
            },
            edit:{
                enable: true,
                showRemoveBtn :true,
                showRenameBtn :true,
                removeTitle :"删除",
                renameTitle :"修改",
                drag:{
                    isMove:true,
                    prev:true,
                    next:true,
                    inner:true
                }
            },
            data:{
                keep: {
                    leaf : true,
                    parent : true
                },
                simpleData : {
                    enable:true,
                    idkey: "id",
                    pIdKey: "pId"
                }
            }
        };
        function addHoverDom(treeId, treeNode) {
            var sObj = $("#" + treeNode.tId + "_span"); //获取节点信息
            if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;

            var addStr = "<span class='button add' id='addBtn_" + treeNode.tId + "' title='add node' onfocus='this.blur();'></span>"; //定义添加按钮
            sObj.after(addStr); //加载添加按钮
            var btn = $("#addBtn_"+treeNode.tId);

            //绑定添加事件，并定义添加操作
            if (btn) btn.bind("click", function(){
                var zTree = $.fn.zTree.getZTreeObj("tree_container");
                //将新节点添加到数据库中
                var name='NewNode';
                $.post('./index.php?r=data/addtree&pid='+treeNode.id+'&name='+name,function (data) {
                    var newID = data; //获取新添加的节点Id
                    zTree.addNodes(treeNode, {id:newID, pId:treeNode.id, name:name}); //页面上添加节点
                    var node = zTree.getNodeByParam("id", newID, null); //根据新的id找到新添加的节点
                    zTree.selectNode(node); //让新添加的节点处于选中状态
                });
            });
        };
        function removeHoverDom(treeId, treeNode) {
            $("#addBtn_"+treeNode.tId).unbind().remove();
        };
        zTreeObj = $.fn.zTree.init($("#tree_container"), setting,node).expandAll(true);


        //右侧表格
       $('#tableItem').DataTable( {
           "processing": true,
           "serverSide": true,
           "ajax": {
               "url": "__SCRIPT__/safety_statutesdi.php"
           },
           "dom": '<"mybtn1 btn btn-outline btn-primary"><"myl"l>frtip',
           "columnDefs": [
               {
                   "searchable": false,
                   "orderable": false,
                   "targets": [2],
                   "render" :  function(data,type,row) {
                       var html = "<input type='button' class='btn btn-info btn-outline btn-xs' style='margin-left: 5px;' onclick='zedit(this)' value='查看'/>";
                       html += "<input type='button' class='btn btn-primary btn-outline btn-xs' style='margin-left: 5px;' onclick='zedit(this)' value='编辑'/>" ;
                       html += "<input type='button' class='btn btn-success btn-outline btn-xs' style='margin-left: 5px;' onclick='showpdf1(this)' value='预览'/>" ;
                       html += "<input type='button' class='btn btn-danger btn-outline btn-xs' style='margin-left: 5px;' onclick='zdel(this)' value='删除'/>" ;
                       return html;
                   }
               }
           ],
           "language": {
               "lengthMenu": "每页_MENU_ 条记录",
               "zeroRecords": "没有找到记录",
               "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
               "infoEmpty": "无记录",
               "search": "搜索：",
               "infoFiltered": "(从 _MAX_ 条记录过滤)",
               "paginate": {
                   "previous": "上一页",
                   "next": "下一页"
               }
           },
           dom: 'Bfrtip',
           buttons: [
               {
                   text: '上传',
                   className: 'btn btn-primary btn-xs upload',
               }
           ],
       } );


        //上传弹层
        $(function(){
            $('.upload').on('click',function(){
                $('#addRules_modal').modal('show');
            });
            $('#dataImple').jeDate();
        })
        var uploader,state;
        //在点击弹出模态框的时候再初始化WebUploader，解决点击上传无反应问题
        $("#addRules_modal").on("shown.bs.modal",function(){
            uploader = WebUploader.create({
                auto: false,
                // swf文件路径
                swf:  '/static/admin/js/webupload/Uploader.swf',

                // 文件接收服务端。
                server: "{:url('Upload/uploadSdi')}",

                // 选择文件的按钮。可选。
                // 内部根据当前运行是创建，可能是input元素，也可能是flash.
                pick: {
                    multiple: false,
                    id: "#picker",
                    innerHTML: "上传"
                },

                // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
                resize: false

            });
            var $list = $('#addName');

            uploader.on( 'fileQueued', function( file ) {
                $list.val('等待上传...');
                state = 'uploading';
            });

            uploader.on( 'uploadSuccess', function( file ) {
                $list.val(file.name+'已上传成功');
            });

            uploader.on( 'uploadError', function( file ) {
                $list.val('上传出错');
            });



        });
        //关闭模态框销毁WebUploader
        $('#addRules_modal').on('hide.bs.modal', function () {
            uploader.destroy();
        });

        //根据适用性评价设置替换标准是否只读
        $("#psex").change(function(){
            if($(this).find('option:selected').val()==-1){
                $("#alternativeStandard").attr('readonly',false);
            }else{
                $("#alternativeStandard").attr('readonly',true);
            }
        });

        function isEmpty(element,msg) {
            if(!$("#"+element).val()){
                $("#"+element).focus().css('border-color','red');
                layer.msg(msg);
                return;
            }
        }

        //提交表单
        $('#save').click(function(){
            //非空判断
            isEmpty('standardNumr','标准号不能为空');
            isEmpty('addName','文件名称不能为空');
            isEmpty('dataImple','施行日期不能为空');
            isEmpty('psex','适用性评价不能为空');
            isEmpty('pdivision','识别人不能为空');

            if(!$("#alternativeStandard").val()&&!$("#alternativeStandard").attr('readonly')){
                alert("替代标准不能为空");
                return;
            }

            //上传文件
            if ( state === 'uploading' ) {
                uploader.stop();
            } else {
                uploader.upload();
            }
            //表单提交
            $('#memberAdd').ajaxSubmit({
                url: "./uploadSdi",
                type: "post",
                success: complete,
                dataType: 'json'
            });
            function complete(data){
                if(data.code==1){
                    layer.msg("保存成功");
                }else{
                    layer.msg(data.msg, {icon: 5,time:1500,shade: 0.1});
                    return false;
                }
            }
        });
    </script>
</body>
</html>