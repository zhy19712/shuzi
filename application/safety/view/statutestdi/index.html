<link rel="stylesheet" type="text/css" href="/static/admin/webupload/webuploader.css">
<link rel="stylesheet" type="text/css" href="/static/admin/webupload/style.css">
<link rel="stylesheet" href="/static/admin/css/zTreeStyle/zTreeStyle.css">
<link rel="stylesheet" href="/static/admin/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="/static/admin/css/jedate.css">
<link rel="stylesheet" href="/static/admin/css/iconfont.css">
<link rel="stylesheet" href="/static/admin/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/admin/css/font-awesome.min.css">
{include file="public/header" /}
<body>
    <style>
        #tableItem_wrapper{
            visibility: hidden;
        }
        .mycontent{
            width: 20%;
            height: 98%;
            display: inline-block;
            background-color: #fff;
            overflow-x: scroll;
            border-right: 1px solid #ccc;
        }
        .mycontent h2{
            padding: 10px 0;
            margin: 0;
            text-align: center;
            font-size: 16px;
            border-bottom: 1px solid #ccc;
            background: #19aa8d;
            color: #FFF;
        }
        .ztree li span.button.add {
            margin-left:2px;
            margin-right: -1px;
            background-position:-144px 0;
            vertical-align:top;
            *vertical-align:middle;
        }
        .wrapper {
            display: inline-block;
            width: 78%;
            vertical-align: top;
            padding: 0;
        }
        #path{
            line-height: 30px;
            font-weight: 700;
            border-bottom: 1px solid #ccc;
        }

        .dt-buttons{
            float: right;
            margin-top: 5px;
        }
        .btn-primary{
            background-color: none !important;
            border-color: none !important;
        }
        .btn-upload{
            padding: 0;
            margin: 0;
            height: 34px;
        }
        .btn-upload .webuploader-pick{
            padding: 7px 15px;
            border-radius:0;
        }
        #import,#export,#seach,#view,#upload{
            float: right;
            display: inline-block;
            margin: 10px 5px 10px;
        }
        #import,#export,#upload{
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #1ab394;
            cursor: pointer;
        }
        #upload{
            float: none;
        }
        #years{
            width: 100px;
        }
        #tableItem .btn{
            margin-right: 2px;
        }
        .dataTables_wrapper .dataTables_length{
            margin-top: 15px;
        }
        .dataTables_wrapper .dataTables_filter{
            margin-top: 10px;
        }
        .dataTables_wrapper .dataTables_filter input,#years{
            margin: 0;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .dataTables_wrapper .dataTables_filter label{
            font-weight: normal;
        }
        table.dataTable thead th, table.dataTable tfoot th{
            font-weight: normal;
        }
        #rulesDesc{
            border: 1px solid #e5e6e7;
        }
        .webuploader-pick{
            padding: 0;
            background: none;
            color: #1ab394;
        }
        .webuploader-pick-hover{
            background: none;
            color: #FFF;
        }
    </style>

    <div id="mycontent" class="mycontent">
        <h2>法律标准分类</h2>
        <ul id="tree_container" class="ztree"></ul>
        <input type="hidden" name="treeId">
        <input type="hidden" name="currentDragId">
        <input type="hidden" name="groupId">
    </div>
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <div class="row">
                    <div id="path">当前路径:</div>
                    <div id="table_info">
                        <div id="level">
                            <table id="tableItem" class="table table-striped table-bordered" cellspacing="0"  width="100%">
                                <thead>
                                    <tr>
                                        <th>全选
                                            <input type='checkbox' name='all_checked' id="all_checked" class='icheckbox_minimal' value=''>
                                        </th>
                                        <th>序号</th>
                                        <th>标准号</th>
                                        <th>名称</th>
                                        <th>施行日期</th>
                                        <th>替代标准</th>
                                        <th>适用性评价</th>
                                        <th>识别人</th>
                                        <th>上传日期</th>
                                        <th>备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addRules_modal" data-keyboard="false" data-backdrop="static" class="modal animated fadeInRight" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width: 60%;margin: 0 auto;margin-top: 40px;">
        <div class="row">
            <div class="col-sm-12" style="background-color:#fff;">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5></h5>
                    </div>
                    <input type="text" name="uid" id="id1" style="display: none;" value="">
                    <div class="ibox-content">
                        <!--新增用户信息开始-->
                        <form class="form-horizontal" name="memberAdd" id="memberAdd" method="post">
                            <input type="hidden" name="id" id="sid">
                            <input type="hidden" name="group_id" id="group_id">
                            <input type="hidden" name="oldFileName" id="oldFileName">
                            <input type="hidden" name="newFileName" id="newFileName">
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label col-sm-offset-2 col-xs-offset-0">标准号：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="standardNumr" type="text" class="form-control" name="standardNumr" >
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-12 col-xs-12">
                                    <label class="col-xs-3 col-sm-3 control-label">名称：</label>
                                    <div class="myblock col-xs- input-group">
                                        <input id="addName" type="text" class="form-control" name="addName" >
                                        <span class="input-group-btn">
                                            <div class="btn btn-upload" id="picker">上传</div>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-lg-12 col-xs-12">
                                    <label class="col-xs-6 col-sm-3 control-label">识别人：</label>
                                    <div class="myblock col-xs-6 col-sm-9 input-group">
                                        <input id="pdivision" type="text" class="form-control" name="division">
                                    </div>
                                </div>
                                <div class="col-lg-9 col-xs-12 col-lg-offset-3 col-xs-offset-0">
                                    <ul id="siduserZtree" class="ztree"></ul>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label col-sm-offset-2 col-xs-offset-0">施行日期：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="dataImple" type="text" class="form-control" name="dataImple" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">替代标准：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="alternativeStandard" type="text" class="form-control" name="alternativeStandard" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-6 control-label col-xs-offset-0">适用性评价：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <select name="sex" id="psex" class="form-control" >
                                            <option value="0">适用</option>
                                            <option value="-1">过期</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="col-lg-12 col-xs-12">
                                <label class="col-xs-2 col-sm-2 control-label">备注：</label>
                                <div class="myblock col-xs-10 col-sm-10 input-group">
                                    <textarea name="rulesDesc" id="rulesDesc" style="width: 100%;min-height: 100px;"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-xs-12 col-lg-12"  style="text-align: center;margin-top: 10px">
                                    <button class="btn btn-primary" type="button" id="save"><i class="fa fa-save"></i> 保存</button>&nbsp;&nbsp;&nbsp;
                                    <a class="btn btn-danger" data-dismiss="modal"><i class="fa fa-close"></i> 返回</a>
                                </div>
                            </div>
                        </form>
                        <!--新增用户信息结束-->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div>
    </div>


    {include file="public/footer" /}
    <script type="text/javascript" src="/static/admin/webupload/webuploader.min.js"></script>

    <script src="__JS__/jquery.ztree.all.js"></script>
    <script src="__JS__/jquery.dataTables.min.js"></script>
    <script src="__JS__/plugins/dataTables/dataTables.buttons.min.js"></script>
    <script src="__JS__/jquery.jedate.js"></script>
    <script src="__JS__/plugins/iCheck/icheck.min.js"></script>
    <script src="__JS__/pdf.js"></script>
    <script src="__JS__/mypdf.js"></script>

    <script>

        //左侧菜单
        var setting = {
            async: {
                enable : true,
                autoParam: ["pId"],
                type : "post",
                url : "./index",
                dataType :"json"
            },
            view:{
                addHoverDom: addHoverDom,
                removeHoverDom: removeHoverDom,
            },
            edit:{
                enable: true,
                showRemoveBtn :showRemoveBtn,
                showRenameBtn :true,
                removeTitle :"删除",
                renameTitle :"修改",
                drag:{
                    isMove:true,
                    prev:true,
                    next:true,
                    inner:true
                }
            },
            data:{
                simpleData : {
                    enable:true,
                    idkey: "id",
                    pIdKey: "pId"
                }
            },
            callback: {
                onClick: zTreeOnClick,
                beforeRemove: beforeRemove,
                beforeRename: beforeRename,
                beforeDrag: beforeDrag,
                beforeDrop: beforeDrop
            }
        };
        zTreeObj = $.fn.zTree.init($("#tree_container"), setting,null).expandAll(true);
        //添加节点
        function addHoverDom(treeId, treeNode) {
            var sObj = $("#" + treeNode.tId + "_span"); //获取节点信息
            if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;

            var addStr = "<span class='button add' id='addBtn_" + treeNode.tId + "' title='add node' onfocus='this.blur();'></span>"; //定义添加按钮
            sObj.after(addStr); //加载添加按钮
            var btn = $("#addBtn_"+treeNode.tId);

            //绑定添加事件，并定义添加操作
            if (btn) btn.bind("click", function(){
                var zTree = $.fn.zTree.getZTreeObj("tree_container");
                //将新节点添加到数据库中
                var name='新节点';
                $.ajax({
                    url:'{:url("Statutestdi/nodeAdd")}',
                    dataType:'JSON',
                    type:'POST',
                    data:{
                        pid:treeNode.id,
                        pname:name
                    },
                    success:function(data){
                        $('input[type="hidden"][name="treeId"]').val(data.data);
                        var id = $('input[type="hidden"][name="treeId"]').val();
                        zTree.addNodes(treeNode, {id:id,pId:treeNode.id, name:name});
                        console.log(treeNode);
                    }
                });
                //var newID = newNode[0].id;
                //var node = zTree.getNodeByParam("id", newID, treeNode.pId); //根据新的id找到新添加的节点
                //zTree.selectNode(node); //让新添加的节点处于选中状态
                return false;

            });
        };
        function removeHoverDom(treeId, treeNode) {
            $("#addBtn_"+treeNode.tId).unbind().remove();
        };

        //编辑节点
        function beforeRename(treeId, treeNode, newName, isCancel) {
            if (newName.length == 0) {
                layer.msg("节点名称不能为空.");
                return false;
            }
            layer.confirm('确定要编辑该节点？', {
                btn: ['确定','取消']
            }, function(){
                var id=$('input[type="hidden"][name="treeId"]').val();

                $.ajax({
                    url:'{:url("Statutestdi/nodeAdd")}',
                    dataType:'JSON',
                    type:'POST',
                    data:{
                        id:id,
                        pname:newName
                    },
                    success:function(){
                        layer.msg('编辑成功！', {icon: 1});
                    }
                });
            });
        }

        //获取被拖拽节点id
        function beforeDrag(treeId, treeNodes) {
            $('input[type="hidden"][name="currentDragId"]').val(treeNodes[0].id);
        }
        //拖拽节点
        function beforeDrop(treeId, treeNodes, targetNode, moveType, isCopy) {
            var id = $('input[type="hidden"][name="currentDragId"]').val();
            var pid = targetNode.id;
            $.ajax({
                url:'{:url("Statutestdi/nodeAdd")}',
                dataType:'JSON',
                type:'POST',
                data:{
                    id:id,
                    pid:pid
                },
                success:function(){
                    layer.msg('移动成功！', {icon: 1});
                }
            });
        }

        //禁止删除父节点
        function showRemoveBtn(treeId, treeNode) {
            return !treeNode.isParent;
        }

        //删除节点
        function beforeRemove(treeId, treeNode){
            layer.confirm('确定要删除该节点？', {
                btn: ['确定','取消']
            }, function(){
                $.ajax({
                    url:'{:url("Statutestdi/nodeDel")}',
                    dataType:'JSON',
                    type:'POST',
                    data:{
                        id:treeNode.id,
                        pname:treeNode.name
                    },
                    success:function(){
                        var zTree = $.fn.zTree.getZTreeObj("tree_container");
                        var nodes = zTree.getSelectedNodes();
                        for (var i=0, l=nodes.length; i < l; i++) {
                            zTree.removeNode(nodes[i]);
                        }
                        layer.msg('删除成功！', {icon: 1});
                    }

            });
            });
        }

        //点击节点
        function zTreeOnClick(event, treeId, treeNode) {
            console.log(treeNode);
            $('#tableItem_wrapper').css("visibility","visible");
            mytree_node = treeNode;
            groupid = treeNode.id;
            $('input[type="hidden"][name="groupId"]').val(groupid);
            if(treeNode.level){
                $("#mytable1_wrapper").css("display","block");
                tableItem.ajax.url("__SCRIPT__/safety_statutesdi.php?pid=" + groupid).load();
            }else {
                $("#mytable1_wrapper").css("display","none");
            }

            //获取路径
            $.ajax({
                url: "./getParents",
                type: "post",
                data: {id:groupid},
                dataType: "json",
                success: function (res) {
                    if(res.msg === "success"){
                        $("#path").text("当前路径:" + res.path)
                    }
                }
            })

            //构建按版本查询
            viewHistoryVer(groupid);

        };


        //右侧表格
       var tableItem = $('#tableItem').DataTable( {
           processing: true,
           serverSide: true,
           ajax: {
               "url": "__SCRIPT__/safety_statutesdi.php"
           },
           dom: 'lf<"#view"><"#seach"><"#export.export btn-outline btn-primary"><"#import.import btn-outline btn-primary"><"#upload.upload btn-outline btn-primary">rtip',
           columnDefs: [
               {
                   searchable: false,
                   targets:0,
                   //orderable: false,
                   data:null,
                   render:function () {
                       var ipt = "<input type='checkbox' name='checkList' onclick='getSelectId(this)'>";
                       return ipt;
                   }
               },
               {
                   searchable: false,
                   orderable: false,
                   targets: 10,
                   render :  function(data,type,row) {
                       var html = "<input type='button' class='btn btn-success btn-outline btn-xs' style='margin-left: 5px;' onclick='showpdf1(this)' value='预览'/>" ;
                       html += "<input type='button' class='btn btn-info btn-outline btn-xs' style='margin-left: 5px;' onclick='download(this)' value='下载'/>";
                       html += "<input type='button' class='btn btn-primary btn-outline btn-xs' style='margin-left: 5px;' onclick='zedit(this)' value='编辑'/>" ;
                       html += "<input type='button' class='btn btn-danger btn-outline btn-xs' style='margin-left: 5px;' onclick='del(this)' value='删除'/>" ;
                       return html;
                   }
               }
           ],
           language: {
               "lengthMenu": "每页_MENU_ 条记录",
               "zeroRecords": "没有找到记录",
               "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
               "infoEmpty": "无记录",
               "search": "搜索：",
               "infoFiltered": "(从 _MAX_ 条记录过滤)",
               "paginate": {
                   "previous": "上一页",
                   "next": "下一页"
               }
           }
       });

        var selectDom = '<input type="text" id="years">';

        $("div#upload").html('<div>上传文件</div>');
        $("div#seach").html('年度：'+selectDom);
        $('div#import').html('导入');
        $('div#export').html('导出');


        //上传弹层
        $(function(){
            $('.upload').on('click',function(){
                $('#addRules_modal').modal('show');

            });
            $('#dataImple').jeDate();

        })
        var uploader;
        //在点击弹出模态框的时候再初始化WebUploader，解决点击上传无反应问题
        $("#addRules_modal").on("shown.bs.modal",function(){
            uploader = WebUploader.create({
                auto: false,
                // swf文件路径
                swf:  '/static/admin/js/webupload/Uploader.swf',

                // 文件接收服务端。
                server: "{:url('Upload/uploadSdi')}",

                // 选择文件的按钮。可选。
                // 内部根据当前运行是创建，可能是input元素，也可能是flash.
                pick: {
                    multiple: false,
                    id: "#picker",
                    innerHTML: "上传"
                },
                formData:{
                    group_id:'',
                    number:'',
                    go_date:'',
                    standard:'',
                    evaluation:'',
                    sid_user:'',
                },

                // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
                resize: false

            });
            var $list = $('#addName');

            uploader.on( 'fileQueued', function( file ) {
                $('#newFileName').val(file.name);
                $list.val('等待上传...');
            });

            uploader.on( 'uploadSuccess', function( file ,res) {
                $list.val(file.name+'已上传成功');
                complete(res);
            });

            uploader.on( 'uploadError', function( file ) {
                $list.val('上传出错');
            });

            // 文件上传过程中创建进度条实时显示。
            uploader.on('uploadProgress', function (file, percentage) {
                var $li = $('#' + file.id),
                    $percent = $li.find('.progress .progress-bar');
                // 避免重复创建
                if (!$percent.length) {
                    $percent = $('<div class="progress progress-striped active">' +
                        '<div class="progress-bar" role="progressbar" style="width: 0%">' +
                        '</div>' +
                        '</div>').appendTo($li).find('.progress-bar');
                }
                $li.find('p.state').text('上传中');
                $percent.css('width', percentage * 100 + '%');
            });

            uploader.on("uploadStart",function () {
                uploader.options.formData.group_id = $('input[type="hidden"][name="groupId"]').val();
                uploader.options.formData.number = $("#standardNumr").val();
                uploader.options.formData.sdi_name = $("#addName").val();
                uploader.options.formData.go_date = $("#dataImple").val();
                uploader.options.formData.standard = $("#alternativeStandard").val();
                uploader.options.formData.evaluation = $("#psex").val();
                uploader.options.formData.sid_user = $("#pdivision").val();
                uploader.options.formData.remark = $("#rulesDesc").text();
            });
        });
        //关闭模态框销毁WebUploader
        $('#addRules_modal').on('hide.bs.modal', function () {
            uploader.destroy();
            $(':input','#memberAdd')
                .not(':button, :submit, :reset, :hidden')
                .val('')
                .removeAttr('checked')
                .removeAttr('selected');
        });

        //根据适用性评价设置替换标准是否只读
        $("#psex").change(function(){
            if($(this).find('option:selected').val()==-1){
                $("#alternativeStandard").attr('readonly',false);
            }else{
                $("#alternativeStandard").attr('readonly',true).val(' ');
            }
        });

        //从组织机构及用户树中选择负责人
        function getSiduser(event, treeId, treeNode) {
            $('#pdivision').val(treeNode.name);
        };
        //组织机构及用户树
        function siduserZtree() {
            var setting = {
                async: {
                    enable : true,
                    autoParam: ["pId"],
                    type : "post",
                    url : "{:url('Statutestdi/getSiduser')}",
                    dataType :"json"
                },
                data:{
                    keep: {
                        leaf : true,
                        parent : true
                    },
                    simpleData : {
                        enable:true,
                        idkey: "id",
                        pIdKey: "pId"
                    }
                },
                callback: {
                    onClick: getSiduser
                }
            };
            zTreeObj = $.fn.zTree.init($("#siduserZtree"), setting,null);
        }

        $('#pdivision').focus(function(){
            siduserZtree();
        })

        //非空判断
        function isEmpty(element,msg) {
            if(!$("#"+element).val()){
                $("#"+element).focus().css('border-color','red');
                layer.msg(msg);
                return;
            }else{
                $("#"+element).blur().css('border-color','#e5e6e7');
            }
        }

        $('#memberAdd input').blur(function(){
            var _this = $(this);
            if(!_this.val()){
                _this.css('border-color','red');
            }else{
                _this.css('border-color','#e5e6e7');
            }
        });

        //上传保存
        $('#save').click(function(){
            //非空判断
            isEmpty('pdivision','识别人不能为空');
            isEmpty('psex','适用性评价不能为空');
            isEmpty('dataImple','施行日期不能为空');
            isEmpty('addName','文件名称不能为空');
            isEmpty('standardNumr','标准号不能为空');

            if(!$("#alternativeStandard").val()&&!$("#alternativeStandard").attr('readonly')){
                alert("替代标准不能为空");
                return;
            }

            //获取表单数据
            var id = $('#sid').val();
            var group_id = $('input[type="hidden"][name="groupId"]').val();
            var sdi_name = $('#addName').val();
            var sdi_number = $('#standardNumr').val();
            var go_date = $('#dataImple').val();
            var standard = $('#alternativeStandard').val();
            var evaluation = $('#psex').val();
            var sid_user = $('#pdivision').val();
            var remark = $('#rulesDesc').val();
            var oldFileName = $('#oldFileName').val();
            var newFileNmae = $('#newFileName').val();
            //表单提交
            if(!newFileNmae||newFileNmae===oldFileName){
                //修改
                $.ajax({
                    url: "{:url('Statutestdi/sdiEdit')}",
                    type: "post",
                    dataType: 'json',
                    data:{
                        id:id,
                        group_id:group_id,
                        sdi_name:sdi_name,
                        sdi_number:sdi_number,  //标准号
                        go_date:go_date,//执行日期
                        standard:standard,//替代标准
                        evaluation:evaluation,//适用性评价
                        sid_user:sid_user,//识别人
                        remark:remark
                    },
                    success: complete
                });
            }else{
                //上传文件
                uploader.upload();
            }
        });
        //数据返回
        function complete(data){
            var groupid = $('input[type="hidden"][name="groupId"]').val();
            console.log(data);
            if(data.code==1){
                layer.msg(data.msg);
                tableItem.ajax.url("__SCRIPT__/safety_statutesdi.php?pid=" + groupid).load();
                $("#addRules_modal").modal('hide');
            }else{
                layer.msg(data.msg, {icon: 5,time:1500,shade: 0.1});
                return false;
            }
        }

        //删除数据
        function del(that){
            var id = $(that).parent("td").parent("tr").children("td:eq('1')").text();
            layer.confirm('确认删除此条记录吗?', {icon: 3, title:'提示'}, function(index){
                $.ajax({
                    url: "{:url('Statutestdi/sdiDel')}",
                    data: {'id' : id},
                    type: "get",
                    dataType: "json",
                    success: function (res) {
                        if(res.code == 1){
                            layer.msg(res.msg,{icon:1,time:1500,shade: 0.1});
                            tableItem.ajax.url("__SCRIPT__/safety_statutesdi.php").load();
                        }else{
                            layer.msg(res.msg,{icon:0,time:1500,shade: 0.1});
                        }
                    }
                })
                layer.close(index);
            })
        }

        //预览
        function showPdf(id,url) {
            $.ajax({
                url: url,
                type: "post",
                data: {id:id},
                success: function (res) {
                    console.log(res);
                    if(res.code === 1){
                        var path = res.path;
                        window.open("__JS__/web/viewer.html?file=" + path,"_blank");
                    }else {
                        layer.msg(res.msg);
                    }
                }
            })
        }

        function showpdf1(that) {
            var id = $(that).parent("td").parent("tr").children("td:first-child").text();
            showPdf(id,"{:url('Statutestdi/anualPreview')}");
        }

        //文件下载
        function download(that) {
            var id = $(that).parents('tr').find('td:eq(1)').text();
            $.ajax({
                url: "{:url('Statutestdi/sdiDownload')}",
                type: "post",
                dataType: "json",
                data:{
                    id:id
                },
                success: function (res) {
                    if(res.code != 1){
                        layer.msg(res.msg);
                    }else {
                        $("#form_container").empty();
                        var id = $(that).parent("td").parent("tr").children("td:first-child").text();
                        var str = "";
                        str += ""
                            + "<iframe name=downloadFrame"+ id +" style='display:none;'></iframe>"
                            + "<form id=download"+ id +" action='{:url('Statutestdi/sdiDownload')}' method='get' target=downloadFrame"+ id +">"
                            + "<span class='file_name' style='color: #000;'>"+str+"</span>"
                            + "<input class='file_url' style='display: none;' name='id' value="+ id +">"
                            + "<button type='submit' class=btn" + id +"></button>"
                            + "</form>"
                        $("#form_container").append(str);
                        $("#form_container").find(".btn" + id).click();
                    }
                }
            })
        }

        //编辑
        function zedit(that) {
            $('#addRules_modal').modal('show');
            var id = $(that).parents('tr').find('td:eq(1)').text();
            $('#sid').val(id);
            $.ajax({
                url: "{:url('Statutestdi/getOne')}",
                type: "post",
                dataType: "json",
                data:{
                    id:id
                },
                success: function (res) {
                    $('#oldFileName').val(res.filename);
                    $('#standardNumr').val(res.number);
                    $('#dataImple').val(res.go_date);
                    $('#alternativeStandard').val(res.standard);
                    $('#psex').val(res.evaluation);
                    $('#pdivision').val(res.sid_user);
                    $('#addName').val(res.sdi_name);
                    $('#rulesDesc').val(res.remark);
                }
            })
        }

        //全选
        $("#all_checked").click(function(){
            $('[name="checkboxAll"]:checkbox').prop('checked',this.checked);//checked为true时为默认显示的状态
        });

        //导入
        var importExcel = WebUploader.create({
            auto: true,
            // swf文件路径
            swf:  '/static/admin/js/webupload/Uploader.swf',

            // 文件接收服务端。
            server: "{:url('Statutestdi/importExcel')}",

            // 选择文件的按钮。可选。
            // 内部根据当前运行是创建，可能是input元素，也可能是flash.
            pick: {
                multiple: false,
                id: "#import",
                innerHTML: "导入"
            },
            formData:{
                group_id:'',
            },

            // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
            resize: false

        });
        var $list = $('#addName');

        importExcel.on( 'uploadSuccess', function( file ,res) {
            $list.val(file.name+'已上传成功');
            complete(res);
        });

        importExcel.on( 'uploadError', function( file ) {
            $list.val('上传出错');
        });

        // 文件上传过程中创建进度条实时显示。
        importExcel.on('uploadProgress', function (file, percentage) {
            var $li = $('#' + file.id),
                $percent = $li.find('.progress .progress-bar');
            // 避免重复创建
            if (!$percent.length) {
                $percent = $('<div class="progress progress-striped active">' +
                    '<div class="progress-bar" role="progressbar" style="width: 0%">' +
                    '</div>' +
                    '</div>').appendTo($li).find('.progress-bar');
            }
            $li.find('p.state').text('上传中');
            $percent.css('width', percentage * 100 + '%');
        });

        importExcel.on("uploadStart",function () {
            importExcel.options.formData.group_id = $('input[type="hidden"][name="groupId"]').val();
        });

        //删除数组中的指定元素
        Array.prototype.remove = function(val){
            for (var i = 0; i < this.length; i++) {
                if(this[i] === val){
                    this.splice(i,1);
                    break;
                }
            }
            return this;
        }

        //数组去重
        Array.prototype.removalArray = function(){
            var newArr = [];
            for (var i = 0; i < this.length; i++) {
                if(newArr.indexOf(this[i]) == -1){  //indexOf 不兼容IE8及以下
                    newArr.push(this[i]);
                }
            }
            return newArr;
        }

        //获取选中行ID
        var idArr = [];
        function getId(that) {
            var isChecked = $(that).prop('checked');
            var id = $(that).parents('tr').find('td:eq(1)').text();
            if(isChecked){
                idArr.push(id);
                idArr.removalArray();
            }else{
                idArr.remove(id);
                idArr.removalArray();
            }
        }

        //单选
        function getSelectId(that) {
            getId(that);
            console.log(idArr);
        }

        //checkbox全选
        $("#all_checked").on("click", function () {
            if ($(this).prop("checked") === true) {
                $("input[name='checkList']").prop("checked", $(this).prop("checked"));
                $('#tableItem tbody tr').addClass('selected');
                $('input[name="checkList"]').each(function(){
                    getId(this);
                });
            } else {
                $("input[name='checkList']").prop("checked", false);
                $('#tableItem tbody tr').removeClass('selected');
            }
            console.log(idArr);
        });

        //导出
        $('#export').click(function(){
            /*var isChecked = $(this).attr('isChecked');
            if(isChecked){
                return;
            }*/
            $.ajax({
                url: "{:url('Statutestdi/exportExcel')}",
                type: "post",
                dataType: 'json',
                data:{
                    id:idArr,
                },
                success: function (data) {
                    if(data.code==1){
                        layer.msg('导出成功！');
                    }
                }
            });
        });

        //构建查看历史版本
        function viewHistoryVer(groupid) {
            var years = $('#years').val();
            $.ajax({
                url:'{:url("Statutestdi/getHistory")}',
                dataType:'JSON',
                type:'POST',
                data:{
                    group_id:groupid,
                    years:years
                },
                success:function (data) {
                    var dataViewDom = '<select name="" id="history" style="height: 32px">';
                    for (var i=0;i<data.length;i++){
                        dataViewDom += '<option value="">'+data[i]+'</option>';
                    }
                    dataViewDom += '</select>';
                    $('div#view').html(dataViewDom);
                }
            });
        }

        //筛选数据
        function filterData() {
            var years = $('#years').val();
            var pid = $('#group_id').val();
            var times = $('#history').find('option:selected').text();
            $.ajax({
                url:'__SCRIPT__/safety_statutesdi.php',
                dataType:'JSON',
                type:'POST',
                data:{
                    pid:groupid,
                    years:years,
                    times:times
                },
                success:function (data) {
                    console.log(data);
                }
            });
        }

        //按版本查看
        $('#history').change(function(){
            filterData();
        });

        //按年度查看
        $('#years').jeDate({
            isinitVal:true,
            format:"YYYY",
            okfun:function (obj) {
                filterData();
            }
        });
    </script>
</body>
</html>