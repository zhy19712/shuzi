<link rel="stylesheet" type="text/css" href="/static/admin/webupload/webuploader.css">
<link rel="stylesheet" type="text/css" href="/static/admin/webupload/style.css">
<link rel="stylesheet" href="/static/admin/css/zTreeStyle/zTreeStyle.css">
<link rel="stylesheet" href="/static/admin/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="/static/admin/css/jedate.css">
<link rel="stylesheet" href="/static/admin/css/iconfont.css">
<link rel="stylesheet" href="/static/admin/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/admin/css/font-awesome.min.css">
{include file="public/header" /}
<body>
    <style>
        .mycontent{
            margin: 0 10px;
            padding-top: 20px;
            padding-right: 10px;
            width: 20%;
            height: 98%;
            display: inline-block;
            background-color: #fff;
            overflow-x: scroll;
            border-right: 1px solid #ccc;
        }
        .mycontent h2{
            margin: 0;
            text-align: center;
            line-height: 30px;
            font-size: 13px;
            border-bottom: 1px solid #ccc;
            background: #19aa8d;
            color: #FFF;
        }
        #path{
            line-height: 30px;
            font-weight: 700;
            border-bottom: 1px solid #ccc;
        }
        .ztree li span.button.add {
            margin-left:2px;
            margin-right: -1px;
            background-position:-144px 0;
            vertical-align:top;
            *vertical-align:middle;
        }
        .wrapper {
            display: inline-block;
            width: 78%;
            vertical-align: top;
            padding: 0;
        }
        .ibox-content h2.title{
            margin: 0;
            padding-bottom: 15px;
            text-align: center;
            font-size: 20px;
            border-bottom: 1px solid #ccc;
        }
        /*#import,#export,#seach,#exportExcel,#add{
            float: right;
            display: inline-block;
            margin: 10px 5px 10px;
        }
        #import,#export,#exportExcel,#add{
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #00b7ee;
            background: #00b7ee;
            color: #FFF;
            cursor: pointer;
        }*/
        .import,.export,#seach,.export-excel,.add{
            float: right;
            display: inline-block;
            margin: 10px 5px 10px;
        }
        .import,.export,.export-excel,.add{
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #1ab394;
            cursor: pointer;
        }
        .add{
            float: none;
        }
        #tableItem .btn{
            margin-right: 2px;
        }
        .dataTables_wrapper .dataTables_length{
            margin-top: 15px;
        }
        .dataTables_wrapper .dataTables_filter{
            margin-top: 10px;
        }
        .dataTables_wrapper .dataTables_filter input{
            margin: 0;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .dataTables_wrapper .dataTables_filter label{
            font-weight: normal;
        }
        table.dataTable thead th, table.dataTable tfoot th{
            font-weight: normal;
        }
        #manageTableItem_wrapper,#practTableItem_wrapper,#foreignTableItem_wrapper,.title{
            display: none;
        }
        #material,#record{
            padding: 0;
        }
        .webuploader-pick{
            padding: 6px 12px;
            background: none;
            color: #1ab394;
        }
        .webuploader-pick-hover{
            background: none;
            color: #FFF;
        }
        .webuploader-container{
            padding: 0;
        }
        #rulesDesc{
            border: 1px solid #e5e6e7;
        }
        .form-control{
            border-color: #ccc;
        }
        #rulesDesc{
            border: 1px solid #ccc;
        }
        table.dataTable thead th.sorting:first-child:after{
            content:''
        }
        table.dataTable tbody tr.selected{
            background: none;
        }
        table.dataTable thead label{
            margin-bottom: 0;
            font-weight: normal;
        }
    </style>
    <div id="mycontent" class="mycontent">
        <h2>人员教育培训</h2>
        <ul id="tree_container" class="ztree"></ul>
        <input type="hidden" name="id">
        <input type="hidden" name="zid">
        <input type="hidden" name="groupId">
    </div>
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <div class="row">
                    <div id="path">当前路径:</div>
                    <div id="table_info">
                        <div id="level">
                            <table id="manageTableItem" class="table table-striped table-bordered" cellspacing="0"  width="100%">
                                <thead>
                                <tr>
                                    <th>
                                        <label for="manage_all_checked" onselectstart="return false;" style="-moz-user-select:none;">全选</label>
                                        <input type='checkbox' name='all_checked' id="manage_all_checked" class='icheckbox_minimal' value=''>
                                    </th>
                                    <th>序号</th>
                                    <th>姓名</th>
                                    <th>职务</th>
                                    <th>证书名称</th>
                                    <th>证书编号</th>
                                    <th>生效日期</th>
                                    <th>有效期至</th>
                                    <th>培训方式</th>
                                    <th>培训时间</th>
                                    <th>备注</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                            </table>
                            <table id="practTableItem" class="table table-striped table-bordered" cellspacing="0"  width="100%">
                                <thead>
                                <tr>
                                    <th>
                                        <label for="pract_all_checked" onselectstart="return false;" style="-moz-user-select:none;">全选</label>
                                        <input type='checkbox' name='all_checked' id="pract_all_checked" class='icheckbox_minimal' value=''>
                                    </th>
                                    <th>序号</th>
                                    <th>姓名</th>
                                    <th>性别</th>
                                    <th>身份证号</th>
                                    <th>职务/工种</th>
                                    <th>持证情况</th>
                                    <th>联系方式</th>
                                    <th>进场时间</th>
                                    <th>培训内容</th>
                                    <th>培训时间</th>
                                    <th>考试成绩</th>
                                    <th>退场时间</th>
                                    <th>备注</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                            </table>
                            <table id="foreignTableItem" class="table table-striped table-bordered" cellspacing="0"  width="100%">
                                <thead>
                                <tr>
                                    <th>
                                        <label for="foreign_all_checked" onselectstart="return false;" style="-moz-user-select:none;">全选</label>
                                        <input type='checkbox' name='all_checked' id="foreign_all_checked" class='icheckbox_minimal' value=''>
                                    </th>
                                    <th>序号</th>
                                    <th>姓名</th>
                                    <th>性别</th>
                                    <th>身份证号</th>
                                    <th>家庭住址</th>
                                    <th>进场原因</th>
                                    <th>进场时间</th>
                                    <th>培训内容</th>
                                    <th>培训时间</th>
                                    <th>紧急联系人</th>
                                    <th>联系电话</th>
                                    <th>离场时间</th>
                                    <th>备注</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--负责人/管理人新增弹层-->
    <div id="manage_addRules_modal" data-keyboard="false" data-backdrop="static" class="modal animated fadeInRight" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width: 60%;margin: 0 auto;margin-top: 40px;">
        <div class="row">
            <div class="col-sm-12" style="background-color:#fff;">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5></h5>
                    </div>
                    <div class="ibox-content">
                        <!--新增用户信息开始-->
                        <form class="form-horizontal" name="manageAddForm" id="manageAddForm" method="post">
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">姓名：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="name" type="text" class="form-control" name="name" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">职务：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="duties" type="text" class="form-control" name="duties">
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">证书名称：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="certificateName" type="text" class="form-control" name="certificateName" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">证书编号：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="certificateCode" type="text" class="form-control" name="certificateCode">
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">生效日期：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="effectiveDate" type="text" class="form-control effectiveDate" name="effectiveDate">
                                        <span class="input-group-addon effectiveDate">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">有效期至：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="validTillDate" type="text" class="form-control validTillDate" name="validTillDate">
                                        <span class="input-group-addon validTillDate">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">培训方式：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <select name="trainMode" class="form-control" id="trainMode">
                                            <option value="0">送培</option>
                                            <option value="1">自培</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">培训时间：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="trainTimeDate" type="text" class="form-control trainTimeDate" name="trainTimeDate">
                                        <span class="input-group-addon trainTimeDate">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-12 col-xs-12">
                                    <label class="col-xs-2 col-sm-2 control-label">备注：</label>
                                    <div class="myblock col-xs-8 col-sm-8 input-group">
                                        <textarea name="rulesDesc" id="rulesDesc" style="width: 100%;min-height: 100px;"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-xs-12 col-lg-12"  style="text-align: center;margin-top: 10px">
                                    <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i> 保存</button>&nbsp;&nbsp;&nbsp;
                                    <a class="btn btn-danger" data-dismiss="modal"><i class="fa fa-close"></i> 返回</a>
                                </div>
                            </div>
                        </form>
                        <!--新增用户信息结束-->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--从业人员新增弹层-->
    <div id="pract_addRules_modal" data-keyboard="false" data-backdrop="static" class="modal animated fadeInRight" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width: 60%;margin: 0 auto;margin-top: 40px;">
        <div class="row">
            <div class="col-sm-12" style="background-color:#fff;">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5></h5>
                    </div>
                    <div class="ibox-content">
                        <!--新增用户信息开始-->
                        <form class="form-horizontal" name="practAddForm" id="practAddForm" method="post">
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">姓名：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="practName" type="text" class="form-control" name="practName" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">性别：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <select name="practSex" class="form-control" id="practSex">
                                            <option value="0">男</option>
                                            <option value="1">女</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">身份证号：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="practIdCode" type="text" class="form-control" name="practIdCode" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">职务/工种：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="worktype" type="text" class="form-control" name="worktype">
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">持证情况：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="iscertificate" type="text" class="form-control" name="iscertificate" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">联系方式：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="contact" type="text" class="form-control" name="contact">
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">进场时间：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="approachDate" type="text" class="form-control approachDate" name="approachDate">
                                        <span class="input-group-addon approachDate">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">退场时间：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="exitDate" type="text" class="form-control exitDate" name="exitDate">
                                        <span class="input-group-addon exitDate">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">培训时间：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="practTrainTimeDate" type="text" class="form-control practTrainTimeDate" name="practTrainTimeDate">
                                        <span class="input-group-addon practTrainTimeDate">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">考试成绩：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="achievement" type="text" class="form-control" name="achievement">
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">培训内容：</label>
                                    <div class="myblock col-xs-6 col-sm-8 input-group">
                                        <textarea name="practContent" id="practContent" style="width: 100%;min-height: 100px;"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-12 col-xs-12">
                                    <label class="col-xs-2 col-sm-2 control-label">备注：</label>
                                    <div class="myblock col-xs-8 col-sm-8 input-group">
                                        <textarea name="practRulesDesc" id="practRulesDesc" style="width: 100%;min-height: 100px;"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-xs-12 col-lg-12"  style="text-align: center;margin-top: 10px">
                                    <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i> 保存</button>&nbsp;&nbsp;&nbsp;
                                    <a class="btn btn-danger" data-dismiss="modal"><i class="fa fa-close"></i> 返回</a>
                                </div>
                            </div>
                        </form>
                        <!--新增用户信息结束-->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--外来人员新增弹层-->
    <div id="foreign_addRules_modal" data-keyboard="false" data-backdrop="static" class="modal animated fadeInRight" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width: 60%;margin: 0 auto;margin-top: 40px;">
        <div class="row">
            <div class="col-sm-12" style="background-color:#fff;">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5></h5>
                    </div>
                    <div class="ibox-content">
                        <!--新增用户信息开始-->
                        <form class="form-horizontal" name="foreignAddForm" id="foreignAddForm" method="post">
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">姓名：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="foreignName" type="text" class="form-control" name="foreignName" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">性别：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <select name="foreignSex" class="form-control" id="foreignSex">
                                            <option value="0">男</option>
                                            <option value="1">女</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">身份证号：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="foreignIdCode" type="text" class="form-control" name="foreignIdCode" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">家庭住址：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="address" type="text" class="form-control" name="address">
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">进场原因：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="reason" type="text" class="form-control" name="reason" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">进场时间：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="foreignApproachDate" type="text" class="form-control foreignApproachDate" name="foreignApproachDate">
                                        <span class="input-group-addon foreignApproachDate">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">培训内容：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="foreignContent" type="text" class="form-control" name="foreignContent" >
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">培训时间：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="foreignTrainTimeDate" type="text" class="form-control foreignTrainTimeDate" name="foreignTrainTimeDate">
                                        <span class="input-group-addon foreignTrainTimeDate">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">紧急联系人：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="emergencyContact" type="text" class="form-control" name="emergencyContact">
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">联系电话：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="contactNumber" type="text" class="form-control" name="contactNumber">
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-6 col-sm-4 control-label">离场时间：</label>
                                    <div class="myblock col-xs-6 input-group">
                                        <input id="departureDate" type="text" class="form-control departureDate" name="departureDate">
                                        <span class="input-group-addon departureDate">
                                            <i class="fa fa-calendar"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-xs-12">
                                    <label class="col-xs-2 col-sm-4 control-label">备注：</label>
                                    <div class="myblock col-xs-8 input-group">
                                        <textarea name="foreignRulesDesc" id="foreignRulesDesc" style="width: 100%;min-height: 100px;"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-xs-12 col-lg-12"  style="text-align: center;margin-top: 10px">
                                    <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i> 保存</button>&nbsp;&nbsp;&nbsp;
                                    <a class="btn btn-danger" data-dismiss="modal"><i class="fa fa-close"></i> 返回</a>
                                </div>
                            </div>
                        </form>
                        <!--新增用户信息结束-->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="form_container" style="display: none;"></div>
    {include file="public/footer" /}
    <script type="text/javascript" src="/static/admin/webupload/webuploader.min.js"></script>

    <script src="__JS__/jquery.ztree.all.js"></script>
    <script src="__JS__/jquery.dataTables.min.js"></script>
    <script src="__JS__/plugins/dataTables/dataTables.buttons.min.js"></script>
    <script src="__JS__/jquery.jedate.js"></script>
    <script src="__JS__/pdf.js"></script>
    <script src="__JS__/mypdf.js"></script>
    <script src="__JS__/plugins/validate/jquery.validate.min.js"></script>

    <script>
        var idArr = [];
        //TODO  以下重复代码需要重构
        $('.effectiveDate').jeDate();
        $('.validTillDate').jeDate();
        $('.trainTimeDate').jeDate();

        $('.approachDate').jeDate();
        $('.exitDate').jeDate();
        $('.practTrainTimeDate').jeDate();

        $('.foreignApproachDate').jeDate();
        $('.foreignTrainTimeDate').jeDate();
        $('.departureDate').jeDate();

        //请求树子节点
        /*var childNodes = [];
        function getChildNode() {
            $.ajax({
                url: "{:url('edupeople/getSegment')}",
                type: "post",
                dataType: "json",
                success: function (res) {
                    $.each(res,function (n,i) {
                        childNodes.push({
                            name:n
                        });
                    })
                }
            });
        }
        getChildNode();*/
        //左侧菜单
        var setting = {
            async: {
                enable : true,
                autoParam: ["pId"],
                type : "post",
                url : "{:url('edupeople/getSegment')}",
                dataType :"json"
            },
            data:{
                simpleData : {
                    enable:true,
                    idkey: "id",
                    pIdKey: "pId"
                }
            },
            callback: {
                onClick: zTreeOnClick,
            }
        };
        /*var node = [
            {id:1,pid:0,name: "主要负责人和安全管理人员",children:childNodes},
            {id:2,pid:0,name: "从业人员",children:childNodes},
            {id:3,pid:0,name: "外来人员"}
        ]*/

        zTreeObj = $.fn.zTree.init($("#tree_container"), setting,null).expandAll(true);
        //TODO 应该有更好的方式实现
        /*setTimeout(function () {
            zTreeObj = $.fn.zTree.init($("#tree_container"), setting,null).expandAll(true);
        },200);*/

        /**
         *  右侧表格
         **/

        //主要负责人和安全管理人员
        var manageTableItem = $('#manageTableItem').DataTable( {
            processing: true,
            serverSide: true,
            ajax: {
                "url": "__SCRIPT__/safety_edupeople.php"
            },
            dom: 'lf<"#manageExportExcel.export-excel btn-outline btn-primary"><"#manageExport.export btn-outline btn-primary"><"#manageImport.import btn-outline btn-primary"><"#manageAdd.add btn-outline btn-primary">rtip',
            columnDefs: [
                {
                    searchable: false,
                    targets:0,
                    data:null,
                    render:function () {
                        var ipt = "<input type='checkbox' name='manageCheckList' onclick='getSelectId(this)'>";
                        return ipt;
                    }
                },
                {
                    "searchable": false,
                    "orderable": false,
                    "targets": [11],
                    "render" :  function(data,type,row) {
                        var html = "<input type='button' class='btn btn-primary btn-outline btn-xs' style='margin-left: 5px;' onclick='manageEdit(this)' value='编辑'/>" ;
                        html += "<input type='button' class='btn btn-danger btn-outline btn-xs' style='margin-left: 5px;' onclick='manageDel(this)' value='删除'/>" ;
                        return html;
                    }
                }
            ],
            language: {
                "lengthMenu": "每页_MENU_ 条记录",
                "zeroRecords": "没有找到记录",
                "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
                "infoEmpty": "无记录",
                "search": "搜索：",
                "infoFiltered": "(从 _MAX_ 条记录过滤)",
                "paginate": {
                    "previous": "上一页",
                    "next": "下一页"
                }
            }
        });

        //从业人员
        var practTableItem = $('#practTableItem').DataTable( {
            processing: true,
            serverSide: true,
            ajax: {
                "url": "__SCRIPT__/safety_eduployee.php"
            },
            dom: 'lf<"#practExportExcel.export-excel btn-outline btn-primary"><"#practExport.export btn-outline btn-primary"><"#practImport.import btn-outline btn-primary"><"#practAdd.add btn-outline btn-primary">rtip',
            columnDefs: [
                {
                    searchable: false,
                    targets:0,
                    data:null,
                    render:function () {
                        var ipt = "<input type='checkbox' name='practCheckList' onclick='getSelectId(this)'>";
                        return ipt;
                    }
                },
                {
                    "searchable": false,
                    "orderable": false,
                    "targets": [14],
                    "render" :  function(data,type,row) {
                        var html = "<input type='button' class='btn btn-primary btn-outline btn-xs' style='margin-left: 5px;' onclick='practEdit(this)' value='编辑'/>" ;
                        html += "<input type='button' class='btn btn-danger btn-outline btn-xs' style='margin-left: 5px;' onclick='practDel(this)' value='删除'/>" ;
                        return html;
                    }
                }
            ],
            language: {
                "lengthMenu": "每页_MENU_ 条记录",
                "zeroRecords": "没有找到记录",
                "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
                "infoEmpty": "无记录",
                "search": "搜索：",
                "infoFiltered": "(从 _MAX_ 条记录过滤)",
                "paginate": {
                    "previous": "上一页",
                    "next": "下一页"
                }
            }
        });

        //外来人员
        var foreignTableItem = $('#foreignTableItem').DataTable( {
            processing: true,
            serverSide: true,
            ajax: {
                "url": "__SCRIPT__/safety_eduforeignpersonnel.php"
            },
            dom: 'lf<"#foreignExportExcel.export-excel btn-outline btn-primary"><"#foreignExport.export btn-outline btn-primary"><"#foreignImport.import btn-outline btn-primary"><"#foreignAdd.add btn-outline btn-primary">rtip',
            columnDefs: [
                {
                    searchable: false,
                    targets:0,
                    data:null,
                    render:function () {
                        var ipt = "<input type='checkbox' name='foreignCheckList' onclick='getSelectId(this)'>";
                        return ipt;
                    }
                },
                {
                    "searchable": false,
                    "orderable": false,
                    "targets": [14],
                    "render" :  function(data,type,row) {
                        var html = "<input type='button' class='btn btn-primary btn-outline btn-xs' style='margin-left: 5px;' onclick='foreignEdit(this)' value='编辑'/>" ;
                        html += "<input type='button' class='btn btn-danger btn-outline btn-xs' style='margin-left: 5px;' onclick='foreignDel(this)' value='删除'/>" ;
                        return html;
                    }
                }
            ],
            language: {
                "lengthMenu": "每页_MENU_ 条记录",
                "zeroRecords": "没有找到记录",
                "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
                "infoEmpty": "无记录",
                "search": "搜索：",
                "infoFiltered": "(从 _MAX_ 条记录过滤)",
                "paginate": {
                    "previous": "上一页",
                    "next": "下一页"
                }
            }
        });

        $("div#manageAdd").html('新增');
        $("div#practAdd").html('新增');
        $('div#foreignAdd').html('新增');
        $('div#manageImport').html('导入');
        $('div#practImport').html('导入');
        $('div#foreignImport').html('导入');
        $('div#manageExport').html('导出');
        $('div#practExport').html('导出');
        $('div#foreignExport').html('导出');
        $('div#manageExportExcel').html('导出Excel模板');
        $('div#practExportExcel').html('导出Excel模板');
        $('div#foreignExportExcel').html('导出Excel模板');

        //禁止全选排序
        $("thead tr th:first-child").unbind();

        //根据左侧树节点显隐对于表格
        function isHidden(e,treeNode,path,tableItem) {
            $('#'+e).show().siblings().hide();
            tableItem.ajax.url("__SCRIPT__/"+path+".php?pid=" + treeNode.pId+"&zid="+treeNode.id).load();
        }

        //点击节点
        function zTreeOnClick(event, treeId, treeNode) {
            idArr.length=0;
            $('input[type="hidden"][name="zid"]').val(treeNode.id);
            $('input[type="hidden"][name="groupId"]').val(treeNode.pId);

            $('.webuploader-pick').next().css({
                width:'52px',
                height:'32px'
            });

            if(treeNode.pId==1){
                isHidden('manageTableItem_wrapper',treeNode,'safety_edupeople',manageTableItem);
            }
            if(treeNode.pId==2){
                isHidden('practTableItem_wrapper',treeNode,'safety_eduployee',practTableItem);
            }
            if(treeNode.pId==3){
                isHidden('foreignTableItem_wrapper',treeNode,'safety_eduforeignpersonnel',foreignTableItem);
            }
            console.log(treeNode);

            if(treeNode.isParent){
                $('.dataTables_wrapper').hide();
            }

            //获取路径
            $.ajax({
                url: "./getParents",
                type: "post",
                data: {
                    id:treeNode.id,
                    pid:treeNode.pId
                },
                dataType: "json",
                success: function (res) {
                    if(res.msg === "success"){
                        $("#path").text("当前路径:" + res.path)
                    }
                }
            })

        };

        //打开新增弹层
        $('#manageAdd').click(function () {
            $('#manage_addRules_modal').modal('show');
        });
        $('#practAdd').click(function () {
            $('#pract_addRules_modal').modal('show');
        });
        $('#foreignAdd').click(function () {
            $('#foreign_addRules_modal').modal('show');
        });

        //关闭新增弹层
        $('#manage_addRules_modal').on('hide.bs.modal', function () {
            manageValidator.resetForm();//重置form表单
            $('input[type="hidden"][name="id"]').val('');  //清除编辑ID
        });
        $('#pract_addRules_modal').on('hide.bs.modal', function () {
            practValidator.resetForm();//重置form表单
            $('input[type="hidden"][name="id"]').val('');  //清除编辑ID
        });
        $('#foreign_addRules_modal').on('hide.bs.modal', function () {
            foreignValidator.resetForm();//重置form表单
            $('input[type="hidden"][name="id"]').val('');  //清除编辑ID
        });

        /**
         * 主要负责人和安全管理人员 增删改
         */
        //新增主要负责人和安全管理人员
        var manageValidator = $("#manageAddForm").validate({
            submitHandler: function(form) {
                //获取表单数据
                var id = $('input[type="hidden"][name="id"]').val();
                var zid = $('input[type="hidden"][name="zid"]').val();
                var pid = $('input[type="hidden"][name="groupId"]').val();
                var edu_name = $('#name').val();
                var job = $('#duties').val();
                var certificate_name = $('#certificateName').val();
                var certificate_number = $('#certificateCode').val();
                var availability_date = $('#effectiveDate').val();
                var vld = $('#validTillDate').val();
                var training_mode = $('#trainMode option:selected').val();
                var training_time = $('#trainTimeDate').val();
                var remark = $('#rulesDesc').val();
                //表单提交
                $(form).ajaxSubmit({
                    url: "{:url('edupeople/eduAdd')}",
                    type: "post",
                    dataType: 'json',
                    data:{
                        major_key:id,
                        zid:zid,
                        pid:pid,
                        edu_name:edu_name,
                        job:job,
                        certificate_name:certificate_name,
                        certificate_number:certificate_number,
                        availability_date:availability_date,
                        vld:vld,
                        training_mode:training_mode,
                        training_time:training_time,
                        remark:remark
                    },
                    success: manageComplete
                });
            },
            rules: {
                name: "required",
                duties: "required",
                certificateName: "required",
                certificateCode: "required",
                effectiveDate: "required",
                validTillDate: "required",
                trainTimeDate: "required"
            },
            messages: {
                name: "姓名不能为空",
                duties: "职务不能为空",
                certificateName: "证书名称不能为空",
                certificateCode: "证书编号不能为空",
                effectiveDate: "生效日期不能为空",
                validTillDate: "有效期至不能为空",
                trainTimeDate: "培训时间不能为空"
            }
        });

        //数据返回主要负责人和安全管理人员
        function manageComplete(data){
            var pid = $('input[type="hidden"][name="groupId"]').val();
            var zid = $('input[type="hidden"][name="zid"]').val();
            console.log(data);
            if(data.code==1){
                layer.msg(data.msg);
                manageTableItem.ajax.url('__SCRIPT__/safety_edupeople.php?pid=' + pid +'&zid='+ zid).load();
                manageImportExcel.reset();
                $("#manage_addRules_modal").modal('hide');
            }else{
                layer.msg(data.info, {icon: 5});
                manageImportExcel.reset();
                return false;
            }
        }

        //删除主要负责人和安全管理人员数据
        function manageDel(that){
            var id = $(that).parent("td").parent("tr").children("td:eq('1')").text();
            layer.confirm('确认删除此条记录吗?', {icon: 3, title:'提示'}, function(index){
                $.ajax({
                    url: "{:url('Edupeople/eduDel')}",
                    data: {'major_key' : id},
                    type: "get",
                    dataType: "json",
                    success: function (res) {
                        if(res.code == 1){
                            layer.msg(res.msg,{icon:1,time:1500,shade: 0.1});
                            manageTableItem.ajax.url("__SCRIPT__/safety_edupeople.php?pid="+ id).load();
                        }else{
                            layer.msg(res.msg,{icon:0,time:1500,shade: 0.1});
                        }
                    }
                })
                layer.close(index);
            })
        }

        //编辑主要负责人和安全管理人员弹层
        function manageEdit(that) {
            $('#manage_addRules_modal').modal('show');
            var id = $(that).parents('tr').find('td:eq(1)').text();
            $('input[type="hidden"][name="id"]').val(id);
            $.ajax({
                url: "{:url('Edupeople/index')}",
                type: "post",
                dataType: "json",
                data:{
                    major_key:id
                },
                success: function (res) {
                    $('#name').val(res.edu_name);
                    $('#duties').val(res.job);
                    $('#certificateName').val(res.certificate_name);
                    $('#certificateCode').val(res.certificate_number);
                    $('#effectiveDate').val(res.availability_date);
                    $('#validTillDate').val(res.vld);
                    $('#trainMode').val(res.training_mode);
                    $('#trainTimeDate').val(res.training_time);
                    $('#rulesDesc').val(res.remark);
                }
            })
        }

        //导出excelExport主要负责人和安全管理人员
        $("#manageExport").click(function () {
            var url = "{:url('Edupeople/exportExcel')}";
            $.ajax({
                url: url,
                type: "post",
                data: {
                    'majorKeyArr':idArr
                },
                dataType: "json",
                success: function (res) {
                    if(res.code ==1){
                        $("#form_container").empty();
                        var str = '<iframe name="exportExcelFrame" style="display:none;"></iframe>'
                            +'<form action='+url+' method="get" target="exportExcelFrame">';
                        for (var i = 0; i < idArr.length; i++)
                        {
                            str += '<input style="display: none;" name="majorKeyArr[]" value="'+ idArr[i] +'">';
                        }
                        str += '<button type="submit" id="exportExcelBtn"></button></form>';
                        $("#form_container").append(str);
                        $("#form_container").find("#exportExcelBtn").click();
                    }else{
                        alert("获取数据失败！")
                    }
                }
            })
        });

        //导出excelExport模板主要负责人和安全管理人员
        $("#manageExportExcel").click(function () {
            var manageUrlExcel = "{:url('Edupeople/exportExcelTemplete')}";
            $.ajax({
                url: manageUrlExcel,
                type: "post",
                data: {
                    'majorKeyArr':idArr
                },
                dataType: "json",
                success: function (res) {
                    if(res.code ==1){
                        $("#form_container").empty();
                        var str = '<iframe name="exportExcelFrame" style="display:none;"></iframe>'
                            +'<form action='+ manageUrlExcel +' method="get" target="exportExcelFrame">';
                        for (var i = 0; i < idArr.length; i++)
                        {
                            str += '<input style="display: none;" name="majorKeyArr[]" value="'+ idArr[i] +'">';
                        }
                        str += '<button type="submit" id="exportExcelBtn"></button></form>';
                        $("#form_container").append(str);
                        $("#form_container").find("#exportExcelBtn").click();
                    }else{
                        alert("获取数据失败！")
                    }
                }
            })
        });

        //导入主要负责人和安全管理人员
        var manageImportExcel = WebUploader.create({
            auto: true,
            // swf文件路径
            swf:  '/static/admin/js/webupload/Uploader.swf',

            // 文件接收服务端。
            server: "{:url('Edupeople/importExcel')}",

            // 选择文件的按钮。可选。
            // 内部根据当前运行是创建，可能是input元素，也可能是flash.
            pick: {
                multiple: false,
                id: "#manageImport",
                innerHTML: "导入"
            },
            formData:{
                pid:'',
                zid:''
            },
            accept: {
                title: 'excel',
                extensions: 'xls,xlsx',
                mimeTypes: '.xls,.xlsx'
            },

            // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
            resize: false
        });

        manageImportExcel.on( 'uploadSuccess', function( file ,res) {
            manageComplete(res);
        });

        manageImportExcel.on( 'uploadError', function( file ) {
            layer.msg('导入失败');
        });

        manageImportExcel.on("uploadStart",function () {
            manageImportExcel.options.formData.pid = $('input[type="hidden"][name="groupId"]').val();
            manageImportExcel.options.formData.zid = $('input[type="hidden"][name="zid"]').val();
        });

        /**
         * 从业人员 增删改
         */
        //新增从业人员
        var practValidator = $("#practAddForm").validate({
            submitHandler: function(form) {
                //获取表单数据
                var id = $('input[type="hidden"][name="id"]').val();
                var zid = $('input[type="hidden"][name="zid"]').val();
                var pid = $('input[type="hidden"][name="groupId"]').val();
                var edu_name = $('#practName').val();
                var sex = $('#practSex option:selected').val();
                var id_on = $('#practIdCode').val();
                var job = $('#worktype').val();
                var situation = $('#iscertificate').val();
                var iphone = $('#contact').val();
                var approach_time = $('#approachDate').val();
                var content = $('#practContent').val();
                var edu_time = $('#exitDate').val();
                var exit_time = $('#practTrainTimeDate').val();
                var exam_performance = $('#achievement').val();
                var remark = $('#practRulesDesc').val();
                //表单提交
                $(form).ajaxSubmit({
                    url: "{:url('Eduemployee/eduAdd')}",
                    type: "post",
                    dataType: 'json',
                    data:{
                        major_key:id,
                        zid:zid,
                        pid:pid,
                        edu_name:edu_name,
                        sex:sex,
                        id_on:id_on,
                        job:job,
                        situation:situation,
                        iphone:iphone,
                        approach_time:approach_time,
                        content:content,
                        exit_time:exit_time,
                        edu_time:edu_time,
                        exam_performance:exam_performance,
                        remark:remark
                    },
                    success: practComplete
                });
            },
            rules: {
                name: "required",
                idcode: "required",
                worktype: "required",
                iscertificate: "required",
                contact: "required",
                approachDate: "required",
                exitDate: "required",
                practTrainTimeDate: "required",
                achievement: "required"
            },
            messages: {
                name: "姓名不能为空",
                idcode: "身份证号不能为空",
                worktype: "职务/工种不能为空",
                iscertificate: "持证情况不能为空",
                contact: "联系方式不能为空",
                approachDate: "进场时间不能为空",
                exitDate: "退场时间不能为空",
                practTrainTimeDate: "培训时间不能为空",
                achievement: "考试成绩不能为空"
            }
        });

        //数据返回从业人员
        function practComplete(data){
            var pid = $('input[type="hidden"][name="groupId"]').val();
            var zid = $('input[type="hidden"][name="zid"]').val();
            console.log(data);
            if(data.code==1){
                layer.msg(data.msg);
                practTableItem.ajax.url('__SCRIPT__/safety_eduployee.php?pid=' + pid +'&zid='+ zid).load();
                practImportExcel.reset();
                $("#pract_addRules_modal").modal('hide');
            }else{
                layer.msg(data.info, {icon: 5});
                practImportExcel.reset();
                return false;
            }
        }

        //删除从业人员
        function practDel(that){
            var id = $(that).parent("td").parent("tr").children("td:eq('1')").text();
            layer.confirm('确认删除此条记录吗?', {icon: 3, title:'提示'}, function(index){
                $.ajax({
                    url: "{:url('Eduemployee/eduDel')}",
                    data: {'major_key' : id},
                    type: "get",
                    dataType: "json",
                    success: function (res) {
                        if(res.code == 1){
                            layer.msg(res.msg,{icon:1,time:1500,shade: 0.1});
                            practTableItem.ajax.url("__SCRIPT__/safety_eduployee.php?pid="+ id).load();
                        }else{
                            layer.msg(res.msg,{icon:0,time:1500,shade: 0.1});
                        }
                    }
                })
                layer.close(index);
            })
        }

        //编辑从业人员
        function practEdit(that) {
            $('#pract_addRules_modal').modal('show');
            var id = $(that).parents('tr').find('td:eq(1)').text();
            $('input[type="hidden"][name="id"]').val(id);
            $.ajax({
                url: "{:url('Eduemployee/index')}",
                type: "post",
                dataType: "json",
                data:{
                    major_key:id
                },
                success: function (res) {
                    $('#practName').val(res.edu_name);
                    $('#practSex').val(res.sex);
                    $('#practIdCode').val(res.id_on);
                    $('#worktype').val(res.job);
                    $('#iscertificate').val(res.situation);
                    $('#contact').val(res.iphone);
                    $('#approachDate').val(res.approach_time);
                    $('#exitDate').val(res.edu_time);
                    $('#practTrainTimeDate').val(res.exit_time);
                    $('#achievement').val(res.exam_performance);
                    $('#practContent').val(res.content);
                    $('#practRulesDesc').val(res.remark);
                }
            })
        }

        //导出从业人员excel
        $("#practExport").click(function () {
            var practUrl = "{:url('Eduemployee/exportExcel')}";
            $.ajax({
                url: practUrl,
                type: "post",
                data: {
                    'majorKeyArr':idArr
                },
                dataType: "json",
                success: function (res) {
                    if(res.code ==1){
                        $("#form_container").empty();
                        var str = '<iframe name="exportExcelFrame" style="display:none;"></iframe>'
                            +'<form action='+practUrl+' method="get" target="exportExcelFrame">';
                        for (var i = 0; i < idArr.length; i++)
                        {
                            str += '<input style="display: none;" name="majorKeyArr[]" value="'+ idArr[i] +'">';
                        }
                        str += '<button type="submit" id="exportExcelBtn"></button></form>';
                        $("#form_container").append(str);
                        $("#form_container").find("#exportExcelBtn").click();
                    }else{
                        alert("获取数据失败！")
                    }
                }
            })
        });

        //导出从业人员excel模板
        $("#practExportExcel").click(function () {
            var practUrlExcel = "{:url('Eduemployee/exportExcelTemplete')}";
            $.ajax({
                url: practUrlExcel,
                type: "post",
                data: {
                    'majorKeyArr':idArr
                },
                dataType: "json",
                success: function (res) {
                    if(res.code ==1){
                        $("#form_container").empty();
                        var str = '<iframe name="exportExcelFrame" style="display:none;"></iframe>'
                            +'<form action='+practUrlExcel+' method="get" target="exportExcelFrame">';
                        for (var i = 0; i < idArr.length; i++)
                        {
                            str += '<input style="display: none;" name="majorKeyArr[]" value="'+ idArr[i] +'">';
                        }
                        str += '<button type="submit" id="exportExcelBtn"></button></form>';
                        $("#form_container").append(str);
                        $("#form_container").find("#exportExcelBtn").click();
                    }else{
                        alert("获取数据失败！")
                    }
                }
            })
        });

        //导入从业人员
        var practImportExcel = WebUploader.create({
            auto: true,
            // swf文件路径
            swf:  '/static/admin/js/webupload/Uploader.swf',

            // 文件接收服务端。
            server: "{:url('Eduemployee/importExcel')}",

            // 选择文件的按钮。可选。
            // 内部根据当前运行是创建，可能是input元素，也可能是flash.
            pick: {
                multiple: false,
                id: "#practImport",
                innerHTML: "导入"
            },
            formData:{
                pid:'',
                zid:''
            },
            accept: {
                title: 'excel',
                extensions: 'xls,xlsx',
                mimeTypes: '.xls,.xlsx'
            },

            // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
            resize: false
        });

        practImportExcel.on( 'uploadSuccess', function( file ,res) {
            practComplete(res);
        });

        practImportExcel.on( 'uploadError', function( file ) {
            layer.msg('导入失败');
        });

        practImportExcel.on("uploadStart",function () {
            practImportExcel.options.formData.pid = $('input[type="hidden"][name="groupId"]').val();
            practImportExcel.options.formData.zid = $('input[type="hidden"][name="zid"]').val();
        });

        /**
         * 外来人员 增删改
         */
        //新增外来人员
        var foreignValidator = $("#foreignAddForm").validate({
                submitHandler: function(form) {
                    //获取表单数据
                    var id = $('input[type="hidden"][name="id"]').val();
                    var zid = $('input[type="hidden"][name="zid"]').val();
                    var pid = $('input[type="hidden"][name="groupId"]').val();
                    var edu_name = $('#foreignName').val();
                    var sex = $('#foreignSex option:selected').val();
                    var id_on = $('#foreignIdCode').val();
                    var address = $('#address').val();
                    var approach_cause = $('#reason').val();
                    var approach_time = $('#foreignApproachDate').val();
                    var content = $('#foreignContent').val();
                    var training_time = $('#foreignTrainTimeDate').val();
                    var user = $('#emergencyContact').val();
                    var iphone = $('#contactNumber').val();
                    var departure_time = $('#departureDate').val();
                    var remark = $('#foreignRulesDesc').val();
                    //表单提交
                    $(form).ajaxSubmit({
                        url: "{:url('Eduforeignpersonnel/eduForAdd')}",
                        type: "post",
                        dataType: 'json',
                        data:{
                            major_key:id,
                            zid:zid,
                            pid:pid,
                            edu_name:edu_name,
                            sex:sex,
                            id_on:id_on,
                            address:address,
                            approach_cause:approach_cause,
                            approach_time:approach_time,
                            content:content,
                            training_time:training_time,
                            user:user,
                            iphone:iphone,
                            departure_time:departure_time,
                            remark:remark
                        },
                        success: foreignComplete
                    });
                },
                rules: {
                    foreignName: "required",
                    foreignIdCode: "required",
                    address: "required",
                    reason: "required",
                    foreignApproachDate: "required",
                    foreignContent: "required",
                    foreignTrainTimeDate: "required",
                    emergencyContact: "required",
                    contactNumber: "required",
                    departureDate: "required",
                },
                messages: {
                    foreignName: "required",
                    foreignIdCode: "required",
                    address: "required",
                    reason: "required",
                    foreignApproachDate: "required",
                    foreignContent: "required",
                    foreignTrainTimeDate: "required",
                    emergencyContact: "required",
                    contactNumber: "required",
                    departureDate: "required",
                }
            });

        //数据返回外来人员
        function foreignComplete(data){
            var pid = $('input[type="hidden"][name="groupId"]').val();
            var zid = $('input[type="hidden"][name="zid"]').val();
            console.log(data);
            if(data.code==1){
                layer.msg(data.msg);
                foreignTableItem.ajax.url('__SCRIPT__/safety_eduforeignpersonnel.php?pid=' + pid +'&zid='+ zid).load();
                foreignImportExcel.reset();
                $("#foreign_addRules_modal").modal('hide');
            }else{
                layer.msg(data.info, {icon: 5});
                foreignImportExcel.reset();
                return false;
            }
        }

        //删除外来人员
        function foreignDel(that){
            var id = $(that).parent("td").parent("tr").children("td:eq('1')").text();
            layer.confirm('确认删除此条记录吗?', {icon: 3, title:'提示'}, function(index){
                $.ajax({
                    url: "{:url('Eduforeignpersonnel/eduDel')}",
                    data: {'major_key' : id},
                    type: "get",
                    dataType: "json",
                    success: function (res) {
                        if(res.code == 1){
                            layer.msg(res.msg,{icon:1,time:1500,shade: 0.1});
                            foreignTableItem.ajax.url("__SCRIPT__/safety_eduforeignpersonnel.php?pid="+ id).load();
                        }else{
                            layer.msg(res.msg,{icon:0,time:1500,shade: 0.1});
                        }
                    }
                })
                layer.close(index);
            })
        }

        //编辑外来人员
        function foreignEdit(that) {
            $('#foreign_addRules_modal').modal('show');
            var id = $(that).parents('tr').find('td:eq(1)').text();
            $('input[type="hidden"][name="id"]').val(id);
            $.ajax({
                url: "{:url('Eduforeignpersonnel/index')}",
                type: "post",
                dataType: "json",
                data:{
                    major_key:id
                },
                success: function (res) {
                    $('#foreignName').val(res.edu_name);
                    $('#foreignSex').val(res.sex);
                    $('#foreignIdCode').val(res.id_on);
                    $('#address').val(res.address);
                    $('#reason').val(res.approach_cause);
                    $('#foreignApproachDate').val(res.approach_time);
                    $('#foreignContent').val(res.content);
                    $('#foreignTrainTimeDate').val(res.training_time);
                    $('#emergencyContact').val(res.user);
                    $('#contactNumber').val(res.iphone);
                    $('#departureDate').val(res.departure_time);
                    $('#foreignRulesDesc').val(res.remark);
                }
            })
        }

        //导出excelExport外来人员
        $("#foreignExport").click(function () {
            var foreignUrl = "{:url('Eduforeignpersonnel/exportExcel')}";
            $.ajax({
                url: "./exportExcel",
                type: "post",
                data: {
                    'majorKeyArr':idArr
                },
                dataType: "json",
                success: function (res) {
                    if(res.code ==1){
                        $("#form_container").empty();
                        var str = '<iframe name="exportExcelFrame" style="display:none;"></iframe>'
                            +'<form action='+ foreignUrl +' method="get" target="exportExcelFrame">';
                        for (var i = 0; i < idArr.length; i++)
                        {
                            str += '<input style="display: none;" name="majorKeyArr[]" value="'+ idArr[i] +'">';
                        }
                        str += '<button type="submit" id="exportExcelBtn"></button></form>';
                        $("#form_container").append(str);
                        $("#form_container").find("#exportExcelBtn").click();
                    }else{
                        alert("获取数据失败！")
                    }
                }
            })
        });

        //导出excelExport外来人员
        $("#foreignExportExcel").click(function () {
            var foreignUrlExcel = "{:url('Eduforeignpersonnel/exportExcelTemplete')}";
            $.ajax({
                url: foreignUrlExcel,
                type: "post",
                data: {
                    'majorKeyArr':idArr
                },
                dataType: "json",
                success: function (res) {
                    if(res.code ==1){
                        $("#form_container").empty();
                        var str = '<iframe name="exportExcelFrame" style="display:none;"></iframe>'
                            +'<form action='+ foreignUrlExcel +' method="get" target="exportExcelFrame">';
                        for (var i = 0; i < idArr.length; i++)
                        {
                            str += '<input style="display: none;" name="majorKeyArr[]" value="'+ idArr[i] +'">';
                        }
                        str += '<button type="submit" id="exportExcelBtn"></button></form>';
                        $("#form_container").append(str);
                        $("#form_container").find("#exportExcelBtn").click();
                    }else{
                        alert("获取数据失败！")
                    }
                }
            })
        });

        //导入从业人员
        var foreignImportExcel = WebUploader.create({
            auto: true,
            // swf文件路径
            swf:  '/static/admin/js/webupload/Uploader.swf',

            // 文件接收服务端。
            server: "{:url('Eduforeignpersonnel/importExcel')}",

            // 选择文件的按钮。可选。
            // 内部根据当前运行是创建，可能是input元素，也可能是flash.
            pick: {
                multiple: false,
                id: "#foreignImport",
                innerHTML: "导入"
            },
            formData:{
                pid:'',
                zid:''
            },
            accept: {
                title: 'excel',
                extensions: 'xls,xlsx',
                mimeTypes: '.xls,.xlsx'
            },

            // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
            resize: false
        });

        foreignImportExcel.on( 'uploadSuccess', function( file ,res) {
            foreignComplete(res);
        });

        foreignImportExcel.on( 'uploadError', function( file ) {
            layer.msg('导入失败');
        });

        foreignImportExcel.on("uploadStart",function () {
            foreignImportExcel.options.formData.pid = $('input[type="hidden"][name="groupId"]').val();
            foreignImportExcel.options.formData.zid = $('input[type="hidden"][name="zid"]').val();
        });

        /**
         * 删除数组中指定元素
         * @param val
         * @returns {Array}
         */
        Array.prototype.remove = function(val){
            for (var i = 0; i < this.length; i++) {
                if(this[i] === val){
                    this.splice(i,1);
                    break;
                }
            }
            return this;
        }

        /**
         * 数组去重
         * @returns {Array}
         */
        Array.prototype.removalArray = function(){
            var newArr = [];
            for (var i = 0; i < this.length; i++) {
                if(newArr.indexOf(this[i]) == -1){  //indexOf 不兼容IE8及以下
                    newArr.push(this[i]);
                }
            }
            return newArr;
        }

        //获取选中行ID
        function getId(that) {
            var isChecked = $(that).prop('checked');
            var id = $(that).parents('tr').find('td:eq(1)').text();
            if(isChecked){
                idArr.push(id);
                idArr.removalArray();
            }else{
                idArr.remove(id);
                idArr.removalArray();
            }
        }

        //单选
        function getSelectId(that) {
            getId(that);
            console.log(idArr);
        }

        //checkbox全选主要负责人和安全管理人员
        $("#manage_all_checked").on("click", function () {
            if ($(this).prop("checked") === true) {
                $("input[name='manageCheckList']").prop("checked", $(this).prop("checked"));
                $('#tableItem tbody tr').addClass('selected');
                $('input[name="manageCheckList"]').each(function(){
                    getId(this);
                });
            } else {
                $("input[name='manageCheckList']").prop("checked", false);
                $('#tableItem tbody tr').removeClass('selected');
                $('input[name="manageCheckList"]').each(function(){
                    getId(this);
                });
            }
            console.log(idArr);
        });


    </script>
</body>
</html>